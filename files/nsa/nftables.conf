#!/usr/sbin/nft -f
# =============================================================================
# NSA Server - nftables Firewall Configuration
# =============================================================================
# Purpose: Docker host with WireGuard VPN gateway
# Location: /etc/nftables.conf
#
# Apply:   nft -f /etc/nftables.conf
# Verify:  nft list ruleset
# =============================================================================

flush ruleset

# =============================================================================
# IPv4 FILTER TABLE
# =============================================================================
table ip filter {

    # -------------------------------------------------------------------------
    # INPUT - Packets destined for this server
    # -------------------------------------------------------------------------
    chain INPUT {
        type filter hook input priority filter
        policy drop  # Default deny - explicit allow only

        # Allow established/related connections
        ct state established,related accept

        # Allow loopback
        iif lo accept

        # -------------------------------------------------------------------------
        # Core Services (from LAN + WireGuard)
        # -------------------------------------------------------------------------
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 22 accept comment "SSH"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 9090 accept comment "Cockpit"

        # -------------------------------------------------------------------------
        # WireGuard VPN (from anywhere - external access)
        # Rate limited to prevent brute force/DDoS
        # -------------------------------------------------------------------------
        udp dport 51820 limit rate 30/second burst 50 packets accept comment "WireGuard VPN"

        # -------------------------------------------------------------------------
        # DNS - Pi-hole (from LAN + WireGuard)
        # -------------------------------------------------------------------------
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } udp dport 53 accept comment "DNS (Pi-hole)"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 53 accept comment "DNS (Pi-hole)"

        # -------------------------------------------------------------------------
        # Docker Services (from LAN + WireGuard)
        # -------------------------------------------------------------------------
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 80 accept comment "HTTP (nginx)"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 1883 accept comment "MQTT (Mosquitto)"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport { 443, 8080 } accept comment "Pi-hole Admin (HTTPS)"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 32400 accept comment "Plex"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 8123 accept comment "Home Assistant"
        ip saddr { 192.168.1.0/24, 10.0.0.0/24 } tcp dport 3000 accept comment "ntopng"

        # -------------------------------------------------------------------------
        # ICMP (ping)
        # -------------------------------------------------------------------------
        icmp type echo-request accept comment "Ping"
    }

    # -------------------------------------------------------------------------
    # OUTPUT - Packets originating from this server
    # -------------------------------------------------------------------------
    chain OUTPUT {
        type filter hook output priority filter
        policy accept
    }

    # -------------------------------------------------------------------------
    # FORWARD - Packets routed through this server (VPN + Docker traffic)
    # -------------------------------------------------------------------------
    chain FORWARD {
        type filter hook forward priority filter
        policy drop  # Default deny

        # Allow established/related forwarded connections
        ct state established,related accept

        # Allow VPN clients to access home network
        iifname "wg0" accept comment "WireGuard: VPN to LAN"

        # Allow Docker containers to reach the internet
        iifname "br-*" accept comment "Docker: containers to internet"
        oifname "br-*" accept comment "Docker: internet to containers"
        iifname "docker0" accept comment "Docker: default bridge"
        oifname "docker0" accept comment "Docker: default bridge"
    }
}

# =============================================================================
# IPv4 NAT TABLE
# =============================================================================
table ip nat {

    # -------------------------------------------------------------------------
    # PREROUTING - Redirect DNS to Pi-hole (catches hardcoded DNS)
    # -------------------------------------------------------------------------
    chain PREROUTING {
        type nat hook prerouting priority dstnat
        policy accept

        # Redirect DNS queries to Pi-hole (only if going to external DNS servers)
        # This catches smart TVs and devices with hardcoded DNS (8.8.8.8, etc)
        # Excludes: Traffic already to Pi-hole, from Docker, or from NSA itself
        ip saddr != { 192.168.1.183, 172.16.0.0/12 } ip daddr != 192.168.1.183 udp dport 53 dnat to 192.168.1.183:53 comment "Force DNS to Pi-hole"
        ip saddr != { 192.168.1.183, 172.16.0.0/12 } ip daddr != 192.168.1.183 tcp dport 53 dnat to 192.168.1.183:53 comment "Force DNS to Pi-hole"
    }

    # -------------------------------------------------------------------------
    # POSTROUTING - NAT for outgoing packets
    # -------------------------------------------------------------------------
    chain POSTROUTING {
        type nat hook postrouting priority srcnat
        policy accept

        # Masquerade VPN traffic going to home network
        # Translates: 10.0.0.x (VPN) â†’ 192.168.1.183 (NSA)
        ip saddr 10.0.0.0/24 oif "enp1s0" masquerade comment "WireGuard NAT"

        # Masquerade Docker container traffic to internet
        ip saddr 172.16.0.0/12 oif "enp1s0" masquerade comment "Docker NAT"
    }
}

# =============================================================================
# IPv6 FILTER TABLE
# =============================================================================
# NSA IPv6: fd7a:94b4:f195:7248:83bf:d01b:f427:66da
# =============================================================================
table ip6 filter {

    # -------------------------------------------------------------------------
    # INPUT - Packets destined for this server
    # -------------------------------------------------------------------------
    chain INPUT {
        type filter hook input priority filter
        policy drop  # Default deny

        # Allow established/related connections
        ct state established,related accept

        # Allow loopback
        iif lo accept

        # Allow link-local (required for IPv6 to function)
        ip6 saddr fe80::/10 accept comment "IPv6 link-local"

        # ICMPv6 (required for IPv6 to function properly)
        icmpv6 type { echo-request, echo-reply, nd-neighbor-solicit, nd-neighbor-advert, nd-router-solicit, nd-router-advert, mld-listener-query, mld-listener-report } accept comment "ICMPv6"

        # -------------------------------------------------------------------------
        # Core Services (from LAN IPv6)
        # -------------------------------------------------------------------------
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 22 accept comment "SSH"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 9090 accept comment "Cockpit"

        # -------------------------------------------------------------------------
        # DNS - Pi-hole (from LAN IPv6)
        # -------------------------------------------------------------------------
        ip6 saddr fd7a:94b4:f195:7248::/64 udp dport 53 accept comment "DNS (Pi-hole)"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 53 accept comment "DNS (Pi-hole)"

        # -------------------------------------------------------------------------
        # Docker Services (from LAN IPv6)
        # -------------------------------------------------------------------------
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 80 accept comment "HTTP (nginx)"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 1883 accept comment "MQTT (Mosquitto)"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport { 443, 8080 } accept comment "Pi-hole Admin (HTTPS)"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 32400 accept comment "Plex"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 8123 accept comment "Home Assistant"
        ip6 saddr fd7a:94b4:f195:7248::/64 tcp dport 3000 accept comment "ntopng"
    }

    # -------------------------------------------------------------------------
    # OUTPUT - Packets originating from this server
    # -------------------------------------------------------------------------
    chain OUTPUT {
        type filter hook output priority filter
        policy accept
    }

    # -------------------------------------------------------------------------
    # FORWARD - Packets routed through this server
    # -------------------------------------------------------------------------
    chain FORWARD {
        type filter hook forward priority filter
        policy drop
    }
}

# =============================================================================
# IPv6 NAT TABLE
# =============================================================================
table ip6 nat {

    # -------------------------------------------------------------------------
    # PREROUTING - Redirect DNS to Pi-hole (catches hardcoded DNS)
    # -------------------------------------------------------------------------
    chain PREROUTING {
        type nat hook prerouting priority dstnat
        policy accept

        # Redirect all IPv6 DNS queries to Pi-hole
        ip6 saddr != fd7a:94b4:f195:7248:83bf:d01b:f427:66da udp dport 53 dnat to [fd7a:94b4:f195:7248:83bf:d01b:f427:66da]:53 comment "Force DNS to Pi-hole"
        ip6 saddr != fd7a:94b4:f195:7248:83bf:d01b:f427:66da tcp dport 53 dnat to [fd7a:94b4:f195:7248:83bf:d01b:f427:66da]:53 comment "Force DNS to Pi-hole"
    }
}
