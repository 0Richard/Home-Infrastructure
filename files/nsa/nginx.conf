# =============================================================================
# NSA Server - NGINX Reverse Proxy Configuration
# =============================================================================
# Purpose: HTTP reverse proxy for all browser services + HTTPS for Moltbot
# Location: /srv/docker/nginx/nginx.conf
#
# HTTP (port 80):
#   http://ha       → Home Assistant (127.0.0.1:8123)
#   http://pihole   → Pi-hole Admin  (127.0.0.1:8081)
#   http://plex     → Plex           (127.0.0.1:32400)
#   http://nsa      → Cockpit        (127.0.0.1:9090)
#   http://ntopng   → ntopng         (127.0.0.1:3000)
#   http://laya     → Static site
#   http://hopo     → Static site
#   http://docs     → README docs (markdown)
#
# HTTPS (port 443):
#   https://moltbot → Moltbot gateway (127.0.0.1:18789)
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_host"';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    # WebSocket upgrade map
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # =========================================================================
    # HTTP (port 80)
    # =========================================================================

    # -------------------------------------------------------------------------
    # Default server - catch-all for unknown hostnames
    # -------------------------------------------------------------------------
    server {
        listen 80 default_server;
        server_name _;
        return 404;
    }

    # -------------------------------------------------------------------------
    # Home Assistant - http://ha
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name ha ha.local;

        location / {
            proxy_pass http://127.0.0.1:8123;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (Home Assistant dashboard)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # -------------------------------------------------------------------------
    # Pi-hole Admin - http://pihole
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name pihole pihole.local;

        location / {
            proxy_pass http://127.0.0.1:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # -------------------------------------------------------------------------
    # Plex - http://plex
    # Plex only accepts HTTPS on 32400
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name plex plex.local;

        location / {
            proxy_pass https://127.0.0.1:32400;
            proxy_ssl_verify off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Plex WebSocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # -------------------------------------------------------------------------
    # Cockpit - http://nsa
    # Cockpit serves HTTPS on 9090, so we proxy to its HTTPS endpoint
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name nsa nsa.local;

        location / {
            proxy_pass https://127.0.0.1:9090;
            proxy_ssl_verify off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (Cockpit terminal)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # -------------------------------------------------------------------------
    # ntopng - http://ntopng
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name ntopng ntopng.local;

        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # -------------------------------------------------------------------------
    # Moltbot HTTP → redirect to HTTPS
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name moltbot moltbot.local;
        return 301 https://$host$request_uri;
    }

    # -------------------------------------------------------------------------
    # Laya - http://laya
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name laya laya.local;
        root /usr/share/nginx/sites/laya;
        index index.html;
        location / { try_files $uri $uri/ =404; }
    }

    # -------------------------------------------------------------------------
    # Hopo - http://hopo
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name hopo hopo.local;
        root /usr/share/nginx/sites/hopo;
        index index.html;
        location / { try_files $uri $uri/ =404; }
    }

    # -------------------------------------------------------------------------
    # Docs - http://docs (README + service directory)
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name docs docs.local;
        root /usr/share/nginx/sites/docs;
        index index.html;
        location / { try_files $uri $uri/ =404; }
    }

    # =========================================================================
    # HTTPS (port 443) - Moltbot only
    # =========================================================================

    # -------------------------------------------------------------------------
    # Default HTTPS - reject non-moltbot hostnames
    # -------------------------------------------------------------------------
    server {
        listen 443 ssl default_server;
        server_name _;

        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;

        return 404;
    }

    # -------------------------------------------------------------------------
    # Moltbot - https://moltbot (WebSocket requires secure context)
    # -------------------------------------------------------------------------
    server {
        listen 443 ssl;
        server_name moltbot moltbot.local;

        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;

        location / {
            proxy_pass http://127.0.0.1:18789;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (Moltbot control UI)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
}
