# =============================================================================
# NSA Docker Compose - Home Automation & Web Services
# =============================================================================
# Location: /srv/docker/docker-compose.yml
#
# Commands:
#   docker compose up -d              Start all services
#   docker compose logs -f            View logs
#   docker compose pull && docker compose up -d   Update containers
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Home Assistant - Smart home automation
  # Access: http://ha:8123 or http://192.168.1.183:8123
  # Data: ./homeassistant/
  # ---------------------------------------------------------------------------
  homeassistant:
    container_name: homeassistant
    image: homeassistant/home-assistant:stable
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./homeassistant:/config
    environment:
      - TZ=Europe/London
    restart: unless-stopped
    network_mode: host  # Required for device discovery (mDNS, SSDP)

  # ---------------------------------------------------------------------------
  # NGINX - Web server for static sites
  # Access: http://laya, http://hopo, http://etc (via Pi-hole DNS)
  # Sites: ./nginx/sites/{laya,hopo,etc}/
  # ---------------------------------------------------------------------------
  nginx:
    container_name: nginx
    image: nginx:latest
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites:/usr/share/nginx/sites:ro
    ports:
      - "80:80"
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Mosquitto - MQTT broker for IoT devices
  # Port: 1883
  # Used by: Zigbee2MQTT, Home Assistant
  # ---------------------------------------------------------------------------
  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto:latest
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    ports:
      - "1883:1883"
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Zigbee2MQTT - Zigbee device coordinator
  # Device: Sonoff Zigbee 3.0 USB Dongle Plus
  # Config: ./homeassistant/zigbee2mqtt/
  # ---------------------------------------------------------------------------
  zigbee2mqtt:
    container_name: zigbee2mqtt
    image: koenkk/zigbee2mqtt
    volumes:
      - ./homeassistant/zigbee2mqtt:/app/data
      - /run/udev:/run/udev:ro
    devices:
      - /dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00-port0:/dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00-port0
    environment:
      - TZ=Europe/London
    restart: unless-stopped
    depends_on:
      - mosquitto

  # ---------------------------------------------------------------------------
  # Pi-hole v6 - DNS + Ad blocking + DHCP
  # Access: https://pihole.local/admin or https://192.168.1.183/admin
  # Replaces dnsmasq for DNS
  # Uses host networking (bridge mode has iptables/nftables conflict)
  # ---------------------------------------------------------------------------
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    network_mode: host
    environment:
      TZ: Europe/London
      FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD:-changeme}
      FTLCONF_dns_upstreams: 1.1.1.1;8.8.8.8
      FTLCONF_dns_listeningMode: all
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN    # Required for DHCP
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Plex - Media server
  # Access: http://plex:32400/web or http://192.168.1.183:32400/web
  # Media: /mnt/data/media/ (movies, tv, music)
  # Note: Requires Plex account for initial setup
  # ---------------------------------------------------------------------------
  plex:
    container_name: plex
    image: plexinc/pms-docker:latest
    ports:
      - "32400:32400"
    environment:
      - TZ=Europe/London
      - PLEX_CLAIM=${PLEX_CLAIM:-}  # Optional: claim token from plex.tv/claim
    volumes:
      - ./plex/config:/config
      - ./plex/transcode:/transcode
      - /mnt/data/media:/data:ro    # Media library (read-only)
    restart: unless-stopped
