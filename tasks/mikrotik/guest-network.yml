# =============================================================================
# MikroTik Guest Network Configuration
# =============================================================================
# Isolated guest network with separate bridge, DHCP, and firewall rules
# Guests get public DNS (1.1.1.1, 8.8.8.8) instead of Pi-hole
# =============================================================================

- name: Create guest bridge
  community.routeros.command:
    commands:
      - :if ([/interface bridge find name="{{ guest_bridge_name }}"] = "") do={ /interface bridge add name="{{ guest_bridge_name }}" comment="Guest network isolation" }
  changed_when: false

- name: Assign IP to guest bridge
  community.routeros.command:
    commands:
      - :if ([/ip address find interface="{{ guest_bridge_name }}"] = "") do={ /ip address add address={{ guest_gateway }}/24 interface={{ guest_bridge_name }} comment="Guest network gateway" }
  changed_when: false

- name: Move guest WiFi to guest bridge
  community.routeros.command:
    commands:
      - :foreach i in=[/interface bridge port find interface~"wifi.*-guest" bridge!=="{{ guest_bridge_name }}"] do={ /interface bridge port remove $i }
      - :if ([/interface bridge port find interface="wifi1-guest" bridge="{{ guest_bridge_name }}"] = "") do={ /interface bridge port add interface=wifi1-guest bridge={{ guest_bridge_name }} comment="Guest 2.4GHz" }
      - :if ([/interface bridge port find interface="wifi2-guest" bridge="{{ guest_bridge_name }}"] = "") do={ /interface bridge port add interface=wifi2-guest bridge={{ guest_bridge_name }} comment="Guest 5GHz" }
  changed_when: false

- name: Create guest DHCP pool
  community.routeros.command:
    commands:
      - :if ([/ip pool find name="{{ guest_pool_name }}"] = "") do={ /ip pool add name={{ guest_pool_name }} ranges={{ guest_pool_start }}-{{ guest_pool_end }} comment="Guest DHCP pool" }
  changed_when: false

- name: Create guest DHCP server
  community.routeros.command:
    commands:
      - :if ([/ip dhcp-server find name="dhcp-guest"] = "") do={ /ip dhcp-server add name=dhcp-guest interface={{ guest_bridge_name }} address-pool={{ guest_pool_name }} lease-time={{ guest_lease_time }} comment="Guest DHCP server" }
  changed_when: false

- name: Configure guest DHCP network
  community.routeros.command:
    commands:
      - :if ([/ip dhcp-server network find address="{{ guest_network }}"] = "") do={ /ip dhcp-server network add address={{ guest_network }} gateway={{ guest_gateway }} dns-server={{ guest_dns_servers | join(',') }} comment="Guest network - public DNS" }
  changed_when: false

# Firewall rules for guest isolation
- name: Block guest to LAN
  community.routeros.command:
    commands:
      - :if ([/ip firewall filter find comment="Block guest to LAN"] = "") do={ /ip firewall filter add chain=forward src-address={{ guest_network }} dst-address={{ lan_network }} action=drop comment="Block guest to LAN" place-before=0 }
  changed_when: false

- name: Allow guest DNS to router
  community.routeros.command:
    commands:
      - :if ([/ip firewall filter find comment="Allow guest DNS to router"] = "") do={ /ip firewall filter add chain=input src-address={{ guest_network }} dst-port=53 protocol=udp action=accept comment="Allow guest DNS to router" }
  changed_when: false

- name: Allow guest DHCP
  community.routeros.command:
    commands:
      - :if ([/ip firewall filter find comment="Allow guest DHCP"] = "") do={ /ip firewall filter add chain=input src-address={{ guest_network }} dst-port=67 protocol=udp action=accept comment="Allow guest DHCP" }
  changed_when: false

- name: Block guest to router
  community.routeros.command:
    commands:
      - :if ([/ip firewall filter find comment="Block guest to router"] = "") do={ /ip firewall filter add chain=input src-address={{ guest_network }} action=drop comment="Block guest to router" }
  changed_when: false
