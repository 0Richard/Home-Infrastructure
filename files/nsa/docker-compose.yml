# =============================================================================
# NSA Docker Compose - Home Automation & Web Services
# =============================================================================
# Location: /srv/docker/docker-compose.yml
#
# Commands:
#   docker compose up -d              Start all services
#   docker compose logs -f            View logs
#   docker compose pull && docker compose up -d   Update containers
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Home Assistant - Smart home automation
  # Access: http://ha:8123 or http://192.168.1.183:8123
  # Data: ./homeassistant/
  # ---------------------------------------------------------------------------
  homeassistant:
    container_name: homeassistant
    image: homeassistant/home-assistant:stable
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./homeassistant:/config
    environment:
      - TZ=Europe/London
    restart: unless-stopped
    network_mode: host  # Required for device discovery (mDNS, SSDP)

  # ---------------------------------------------------------------------------
  # NGINX - Reverse proxy for all browser services
  # Access: http://hostname or https://moltbot (via Pi-hole DNS)
  # Proxies: HA, Pi-hole, Plex, Cockpit, Moltbot, ntopng
  # Static sites: laya, hopo, docs
  # ---------------------------------------------------------------------------
  nginx:
    container_name: nginx
    image: nginx:latest
    network_mode: host
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites:/usr/share/nginx/sites:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/syncthing-api-key.conf:/etc/nginx/syncthing-api-key.conf:ro
      - /home/richardbell/Sync/Home-Infrastructure/README.md:/usr/share/nginx/sites/docs/README.md:ro
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Mosquitto - MQTT broker for IoT devices
  # Port: 1883
  # Used by: Zigbee2MQTT, Home Assistant
  # ---------------------------------------------------------------------------
  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto:latest
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    ports:
      - "1883:1883"
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Zigbee2MQTT - Zigbee device coordinator
  # Device: Sonoff Zigbee 3.0 USB Dongle Plus
  # Config: ./homeassistant/zigbee2mqtt/
  # ---------------------------------------------------------------------------
  zigbee2mqtt:
    container_name: zigbee2mqtt
    image: koenkk/zigbee2mqtt
    volumes:
      - ./homeassistant/zigbee2mqtt:/app/data
      - /run/udev:/run/udev:ro
    devices:
      - /dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00-port0:/dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00-port0
    environment:
      - TZ=Europe/London
    restart: unless-stopped
    depends_on:
      - mosquitto

  # ---------------------------------------------------------------------------
  # Pi-hole v6 - DNS + Ad blocking + DHCP
  # Access: http://pihole/admin (via nginx proxy) or http://192.168.1.183:8081/admin
  # Replaces dnsmasq for DNS
  # Web UI on port 8081 (port 80 used by nginx proxy)
  # Uses host networking (bridge mode has iptables/nftables conflict)
  # ---------------------------------------------------------------------------
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    network_mode: host
    environment:
      TZ: Europe/London
      FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD:-changeme}
      FTLCONF_webserver_port: "8081"
      FTLCONF_dns_upstreams: 1.1.1.1;8.8.8.8
      FTLCONF_dns_listeningMode: all
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN    # Required for DHCP
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # ntopng - Network traffic monitoring
  # Access: http://nsa:3000 or http://192.168.1.183:3000
  # Data: /mnt/data/ntopng/ (30 day retention)
  # Monitors: NSA network interface (sees all traffic to/from NSA)
  # ---------------------------------------------------------------------------
  ntopng:
    container_name: ntopng
    image: ntop/ntopng:latest
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=Europe/London
    volumes:
      - /mnt/data/ntopng:/var/lib/ntopng
    command: --community -d /var/lib/ntopng -i enp1s0 -w 3000 --disable-autologout
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Plex - Media server
  # Access: http://plex:32400/web or http://192.168.1.183:32400/web
  # Media: /mnt/data/media/ (movies, tv, music)
  # Note: Requires Plex account for initial setup
  # Hardware transcoding: Intel Quick Sync via /dev/dri (i3-8109U)
  # ---------------------------------------------------------------------------
  plex:
    container_name: plex
    image: plexinc/pms-docker:latest
    ports:
      - "32400:32400"                  # Main Plex port
      - "32410-32414:32410-32414/udp"  # GDM network discovery
      - "32469:32469"                  # DLNA server
    devices:
      - /dev/dri:/dev/dri  # Intel Quick Sync for hardware transcoding
    group_add:
      - "992"  # render group for GPU access
    environment:
      - TZ=Europe/London
      - PLEX_CLAIM=${PLEX_CLAIM:-}  # Optional: claim token from plex.tv/claim
      - ADVERTISE_IP=http://192.168.1.183:32400/  # Help clients find server on LAN
    volumes:
      - ./plex/config:/config
      - ./plex/transcode:/transcode
      - /mnt/data/media:/data:ro    # Media library (read-only)
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Moltbot - AI assistant gateway
  # Access: http://moltbot:18789
  # LLM backend: Ollama on Mini (192.168.1.116:11434)
  # ---------------------------------------------------------------------------
  moltbot-gateway:
    container_name: moltbot-gateway
    image: ghcr.io/moltbot/clawdbot:main
    command: >
      sh -c '
        mkdir -p /home/node/.clawdbot &&
        [ -f /home/node/.clawdbot/clawdbot.json ] ||
        echo "{\"gateway\":{\"mode\":\"local\",\"bind\":\"lan\",\"trustedProxies\":[\"127.0.0.1\"]},\"agents\":{\"defaults\":{\"model\":{\"primary\":\"ollama/qwen2.5:7b-16k\"}}},\"models\":{\"providers\":{\"ollama\":{\"baseUrl\":\"http://192.168.1.116:11434/v1\",\"apiKey\":\"ollama-local\",\"api\":\"openai-completions\",\"models\":[{\"id\":\"qwen2.5:7b-16k\",\"name\":\"Qwen 2.5 7B\",\"reasoning\":false,\"input\":[\"text\"],\"cost\":{\"input\":0,\"output\":0,\"cacheRead\":0,\"cacheWrite\":0},\"contextWindow\":16384,\"maxTokens\":4096}]}}}}" > /home/node/.clawdbot/clawdbot.json &&
        exec node dist/index.js gateway --allow-unconfigured
      '
    network_mode: host
    volumes:
      - /srv/docker/moltbot/state:/home/node/.clawdbot
    environment:
      - TZ=Europe/London
      - OLLAMA_HOST=http://192.168.1.116:11434
      - OLLAMA_API_KEY=ollama-local
      - CLAWDBOT_GATEWAY_TOKEN=${MOLTBOT_TOKEN:-}
    restart: unless-stopped

  moltbot-cli:
    container_name: moltbot-cli
    image: ghcr.io/moltbot/clawdbot:main
    environment:
      - TZ=Europe/London
      - MOLTBOT_GATEWAY=http://moltbot-gateway:18789
      - MOLTBOT_TOKEN=${MOLTBOT_TOKEN:-}
    depends_on:
      - moltbot-gateway
    profiles:
      - tools

