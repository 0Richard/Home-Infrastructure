# =============================================================================
# macOS Power Management Tasks
# =============================================================================
# Prevent sleep, enable auto-login, and ensure always-on availability
# =============================================================================

- name: Disable system sleep (server mode)
  command: pmset -a sleep 0
  tags: power

- name: Disable display sleep
  command: pmset -a displaysleep 0
  tags: power

- name: Disable disk sleep
  command: pmset -a disksleep 0
  tags: power

- name: Enable Wake on LAN
  command: pmset -a womp 1
  tags: power

- name: Disable Power Nap (prevents unexpected wake activities)
  command: pmset -a powernap 0
  tags: power

- name: Restart after power failure
  command: pmset -a autorestart 1
  tags: power

- name: Verify power settings
  command: pmset -g
  register: pmset_output
  changed_when: false
  tags: power

- name: Show power settings
  debug:
    var: pmset_output.stdout_lines
  tags: power

# =============================================================================
# Auto-login (ensures LaunchAgents start after reboot/update)
# =============================================================================
# Without auto-login, macOS sits at the login screen after reboot and
# LaunchAgents (Ollama, Syncthing) won't start until someone logs in.
# Note: FileVault must be OFF for auto-login to work.

- name: Set auto-login user
  command: defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser "richardbell"
  tags: [power, autologin]

- name: Generate kcpassword for auto-login
  script:
    cmd: |
      python3 -c "
      import sys, os
      password = sys.argv[1]
      key = [0x7D, 0x89, 0x52, 0x23, 0xD2, 0xBC, 0xDD, 0xEA, 0xA3, 0xB9, 0x1F]
      pwd_bytes = password.encode('utf-8') + b'\x00'
      while len(pwd_bytes) % 12:
          pwd_bytes += b'\x00'
      result = bytearray(b ^ key[i % len(key)] for i, b in enumerate(pwd_bytes))
      with open('/etc/kcpassword', 'wb') as f:
          f.write(result)
      os.chmod('/etc/kcpassword', 0o600)
      " "{{ vault_mini_login_password }}"
  tags: [power, autologin]
  no_log: true
