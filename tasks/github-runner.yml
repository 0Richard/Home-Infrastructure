# =============================================================================
# GitHub Actions Self-Hosted Runner - Linux
# =============================================================================
# Manages pre-registered runner at ~/actions-runner as a systemd service.
# Runner connects outbound to GitHub (no inbound ports needed).
# Works on LAN and via WireGuard VPN (OUTPUT policy accept).
#
# Prerequisites: Runner already downloaded and registered with GitHub.
#   cd ~/actions-runner && ./config.sh --url https://github.com/ORG/REPO --token TOKEN
#
# Usage:
#   ansible-playbook nsa.yml --tags github-runner
#   ansible-playbook nsa.yml --tags github-runner --check --diff
# =============================================================================

# ---------------------------------------------------------------------------
# Playwright system dependencies (for Chromium in CI)
# ---------------------------------------------------------------------------
- name: Install Playwright system dependencies for Chromium
  apt:
    name:
      - libnss3
      - libatk1.0-0
      - libatk-bridge2.0-0
      - libcups2
      - libdrm2
      - libxkbcommon0
      - libxcomposite1
      - libxdamage1
      - libxrandr2
      - libgbm1
      - libpango-1.0-0
      - libcairo2
      - libasound2
      - libxshmfence1
    state: present
    update_cache: yes

# ---------------------------------------------------------------------------
# AWS CLI v2 (for S3 sync and CloudFormation in deploy jobs)
# ---------------------------------------------------------------------------
- name: Install unzip (required for AWS CLI installer)
  apt:
    name: unzip
    state: present

- name: Check if AWS CLI is installed
  stat:
    path: /usr/local/bin/aws
  register: aws_cli

- name: Download AWS CLI v2
  get_url:
    url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    dest: /tmp/awscliv2.zip
    mode: '0644'
  when: not aws_cli.stat.exists

- name: Unzip AWS CLI installer
  unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp
    remote_src: yes
  when: not aws_cli.stat.exists

- name: Install AWS CLI v2
  command: /tmp/aws/install
  args:
    creates: /usr/local/bin/aws
  when: not aws_cli.stat.exists

- name: Clean up AWS CLI installer
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/awscliv2.zip
    - /tmp/aws
  when: not aws_cli.stat.exists

# ---------------------------------------------------------------------------
# GitHub Actions Runner - systemd service
# ---------------------------------------------------------------------------
- name: Check if runner service is installed
  stat:
    path: "/etc/systemd/system/{{ github_runner_service }}.service"
  register: runner_service

- name: Install GitHub Actions runner as systemd service
  command: ./svc.sh install richardbell
  args:
    chdir: "{{ github_runner_path }}"
    creates: "/etc/systemd/system/{{ github_runner_service }}.service"
  when: not runner_service.stat.exists

- name: Enable and start GitHub Actions runner
  systemd:
    name: "{{ github_runner_service }}"
    enabled: yes
    state: started
    daemon_reload: yes
