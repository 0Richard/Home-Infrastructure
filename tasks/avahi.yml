# =============================================================================
# Avahi Tasks - Linux
# =============================================================================
# mDNS/DNS-SD responder for .local domain resolution
# Enables nsa.local, service discovery on LAN
# =============================================================================

- name: Install Avahi daemon
  apt:
    name:
      - avahi-daemon
      - avahi-utils
    state: present
    update_cache: yes

- name: Configure Avahi daemon
  copy:
    dest: /etc/avahi/avahi-daemon.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      [server]
      host-name={{ inventory_hostname }}
      domain-name=local
      use-ipv4=yes
      use-ipv6=yes
      allow-interfaces=enp1s0
      deny-interfaces=wg0
      ratelimit-interval-usec=1000000
      ratelimit-burst=1000

      [wide-area]
      enable-wide-area=no

      [publish]
      publish-addresses=yes
      publish-hinfo=yes
      publish-workstation=no
      publish-domain=yes
      publish-aaaa-on-ipv4=no
      publish-a-on-ipv6=no

      [reflector]
      enable-reflector=no

      [rlimits]
  notify: Restart avahi

- name: Create Avahi service for SSH
  copy:
    dest: /etc/avahi/services/ssh.service
    owner: root
    group: root
    mode: '0644'
    content: |
      <?xml version="1.0" standalone='no'?>
      <!DOCTYPE service-group SYSTEM "avahi-service.dtd">
      <service-group>
        <name replace-wildcards="yes">%h SSH</name>
        <service>
          <type>_ssh._tcp</type>
          <port>22</port>
        </service>
      </service-group>
  notify: Restart avahi

- name: Enable and start Avahi daemon
  systemd:
    name: avahi-daemon
    enabled: yes
    state: started
