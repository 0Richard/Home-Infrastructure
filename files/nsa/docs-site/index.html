<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Infrastructure</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6; color: #c9d1d9; background: #0d1117;
            max-width: 960px; margin: 0 auto; padding: 24px 16px;
        }
        a { color: #58a6ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        h1 { color: #f0f6fc; margin-bottom: 8px; font-size: 1.8em; }
        h1 + p { color: #8b949e; margin-bottom: 24px; }
        /* Service table */
        .services { width: 100%; border-collapse: collapse; margin-bottom: 32px; }
        .services th { text-align: left; color: #8b949e; font-weight: 600; font-size: 0.85em;
            text-transform: uppercase; letter-spacing: 0.05em;
            padding: 8px 12px; border-bottom: 2px solid #21262d; }
        .services td { padding: 10px 12px; border-bottom: 1px solid #21262d; }
        .services tr:hover { background: #161b22; }
        .services .status { display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; background: #484f58; margin-right: 6px; vertical-align: middle; }
        .services .status.up { background: #3fb950; }
        .services .status.slow { background: #d29922; }
        .services .status.down { background: #f85149; }
        /* README content */
        #readme { border-top: 2px solid #21262d; padding-top: 24px; margin-top: 8px; }
        #readme h1, #readme h2, #readme h3 { color: #f0f6fc; margin: 24px 0 12px; }
        #readme h1 { font-size: 1.6em; border-bottom: 1px solid #21262d; padding-bottom: 8px; }
        #readme h2 { font-size: 1.3em; border-bottom: 1px solid #21262d; padding-bottom: 6px; }
        #readme h3 { font-size: 1.1em; }
        #readme p { margin: 12px 0; }
        #readme table { width: 100%; border-collapse: collapse; margin: 12px 0; }
        #readme th { text-align: left; background: #161b22; color: #f0f6fc; }
        #readme th, #readme td { padding: 8px 12px; border: 1px solid #21262d; }
        #readme code { background: #161b22; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        #readme pre { background: #161b22; padding: 16px; border-radius: 6px;
            overflow-x: auto; margin: 12px 0; }
        #readme pre code { background: none; padding: 0; }
        #readme ul, #readme ol { padding-left: 24px; margin: 8px 0; }
        #readme li { margin: 4px 0; }
        #readme hr { border: none; border-top: 1px solid #21262d; margin: 24px 0; }
        #readme img { max-width: 100%; }
        #readme blockquote { border-left: 3px solid #3fb950; padding-left: 16px; color: #8b949e; }
        .loading { color: #8b949e; font-style: italic; }
        /* Status legend */
        .legend { color: #8b949e; font-size: 0.85em; margin-bottom: 32px; }
        .legend .dot { display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; vertical-align: middle; margin: 0 4px 0 12px; }
        .legend .dot:first-child { margin-left: 0; }
        .legend .dot.g { background: #3fb950; }
        .legend .dot.a { background: #d29922; }
        .legend .dot.r { background: #f85149; }
        .legend .dot.x { background: #484f58; }
        /* Syncthing status */
        .sync-section { margin-bottom: 32px; }
        .sync-section h2 { color: #f0f6fc; font-size: 1.2em; margin-bottom: 12px; }
        .sync-devices { display: flex; gap: 16px; flex-wrap: wrap; }
        .sync-device { background: #161b22; border: 1px solid #21262d; border-radius: 6px;
            padding: 12px 16px; min-width: 140px; }
        .sync-device .name { color: #f0f6fc; font-weight: 600; margin-bottom: 4px; }
        .sync-device .info { color: #8b949e; font-size: 0.85em; }
        .sync-device .status-dot { display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-right: 6px; vertical-align: middle; }
        .sync-device .status-dot.connected { background: #3fb950; }
        .sync-device .status-dot.disconnected { background: #f85149; }
        .sync-folder { color: #8b949e; font-size: 0.85em; margin-top: 12px; }
        .sync-folder .state { color: #c9d1d9; }
        .sync-folder .state.idle { color: #3fb950; }
        .sync-folder .state.syncing { color: #d29922; }
        .sync-folder .state.error { color: #f85149; }
    </style>
</head>
<body>
    <h1>Home Infrastructure</h1>
    <p>Service directory &mdash; all accessible from LAN and WireGuard VPN</p>

    <table class="services">
        <thead>
            <tr><th>Service</th><th>URL</th><th>Direct (IP:Port)</th></tr>
        </thead>
        <tbody>
            <tr>
                <td>Home Assistant</td>
                <td><span class="status" data-check="http://ha./"></span><a href="http://ha./">http://ha</a></td>
                <td><span class="status" data-check="http://192.168.1.183:8123"></span><a href="http://192.168.1.183:8123">192.168.1.183:8123</a></td>
            </tr>
            <tr>
                <td>Pi-hole Admin</td>
                <td><span class="status" data-check="http://pihole./admin"></span><a href="http://pihole./admin">http://pihole/admin</a></td>
                <td><span class="status" data-check="http://192.168.1.183:8081/admin"></span><a href="http://192.168.1.183:8081/admin">192.168.1.183:8081</a></td>
            </tr>
            <tr>
                <td>Plex</td>
                <td><span class="status"></span><a href="http://plex./web">http://plex/web</a></td>
                <td><span class="status"></span><a href="https://192.168.1.183:32400/web">192.168.1.183:32400</a></td>
            </tr>
            <tr>
                <td>Cockpit</td>
                <td><span class="status"></span><a href="http://nsa./">http://nsa</a></td>
                <td><span class="status"></span><a href="https://192.168.1.183:9090">192.168.1.183:9090</a></td>
            </tr>
            <tr>
                <td>Moltbot</td>
                <td><span class="status" data-check="https://moltbot./"></span><a href="https://moltbot./">https://moltbot</a></td>
                <td><span class="status" data-check="http://192.168.1.183:18789"></span><a href="http://192.168.1.183:18789">192.168.1.183:18789</a></td>
            </tr>
            <tr>
                <td>ntopng</td>
                <td><span class="status" data-check="http://ntopng./"></span><a href="http://ntopng./">http://ntopng</a></td>
                <td><span class="status" data-check="http://192.168.1.183:3000"></span><a href="http://192.168.1.183:3000">192.168.1.183:3000</a></td>
            </tr>
            <tr>
                <td>Laya</td>
                <td><span class="status" data-check="http://laya./"></span><a href="http://laya./">http://laya</a></td>
                <td>&mdash;</td>
            </tr>
            <tr>
                <td>Hopo</td>
                <td><span class="status" data-check="http://hopo./"></span><a href="http://hopo./">http://hopo</a></td>
                <td>&mdash;</td>
            </tr>
        </tbody>
    </table>

    <p class="legend">
        <span class="dot g"></span> Reachable
        <span class="dot a"></span> Slow (&gt;3s)
        <span class="dot r"></span> Unreachable
        <span class="dot x"></span> Not checked (HTTPS)
    </p>

    <div class="sync-section">
        <h2>Syncthing</h2>
        <div id="sync-status"><p class="loading">Loading sync status&hellip;</p></div>
    </div>

    <div id="readme"><p class="loading">Loading README&hellip;</p></div>

    <script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
    <script>
        fetch('README.md')
            .then(function(r) { return r.text(); })
            .then(function(md) { document.getElementById('readme').innerHTML = marked.parse(md); })
            .catch(function() { document.getElementById('readme').innerHTML = '<p>Failed to load README.md</p>'; });

        // Syncthing status (fetched on page load via nginx API proxy)
        Promise.all([
            fetch('/api/syncthing/system/connections').then(function(r) { return r.json(); }),
            fetch('/api/syncthing/config/devices').then(function(r) { return r.json(); }),
            fetch('/api/syncthing/db/status?folder=default').then(function(r) { return r.json(); }),
            fetch('/api/syncthing/system/version').then(function(r) { return r.json(); })
        ]).then(function(results) {
            var connections = results[0];
            var devices = results[1];
            var folder = results[2];
            var sysVersion = results[3];
            var totalBytes = folder.globalBytes;

            // Fetch completion per remote device (how much each has synced)
            var completionPromises = devices.map(function(dev) {
                if (dev.name === 'nsa') return Promise.resolve(null);
                return fetch('/api/syncthing/db/completion?device=' + dev.deviceID + '&folder=default')
                    .then(function(r) { return r.json(); })
                    .catch(function() { return null; });
            });

            return Promise.all(completionPromises).then(function(completions) {
                var container = document.getElementById('sync-status');
                var html = '<div class="sync-devices">';
                devices.forEach(function(dev, i) {
                    var isLocal = dev.name === 'nsa';
                    var conn = connections.connections[dev.deviceID] || {};
                    var connected = isLocal || conn.connected || false;
                    var version = isLocal ? sysVersion.version : (conn.clientVersion || '');
                    var completion = completions[i];

                    var sizeStr = '';
                    if (isLocal) {
                        sizeStr = (totalBytes / 1073741824).toFixed(1) + ' GB';
                    } else if (completion && completion.globalBytes) {
                        var synced = (completion.globalBytes - (completion.needBytes || 0)) / 1073741824;
                        sizeStr = synced.toFixed(1) + ' GB';
                    }

                    html += '<div class="sync-device">';
                    html += '<div class="name"><span class="status-dot ' + (connected ? 'connected' : 'disconnected') + '"></span>' + dev.name + '</div>';
                    html += '<div class="info">' + (connected ? version : 'Disconnected') + '</div>';
                    if (sizeStr) html += '<div class="info">' + sizeStr + '</div>';
                    html += '</div>';
                });
                html += '</div>';

                var state = folder.state || 'unknown';
                var stateClass = state === 'idle' ? 'idle' : (state === 'syncing' ? 'syncing' : '');
                var files = (folder.globalFiles / 1000).toFixed(0) + 'k';
                var needFiles = folder.needFiles || 0;
                html += '<div class="sync-folder">';
                html += 'Folder: <span class="state ' + stateClass + '">' + state + '</span>';
                html += ' &mdash; ' + files + ' files';
                if (needFiles > 0) html += ' &mdash; ' + needFiles + ' files out of sync';
                html += '</div>';

                container.innerHTML = html;
            });
        }).catch(function() {
            document.getElementById('sync-status').innerHTML = '<p class="loading">Syncthing API unavailable</p>';
        });

        // Live status checks: green (<3s), amber (3-5s slow), red (failed/timeout)
        document.querySelectorAll('.status[data-check]').forEach(function(dot) {
            var url = dot.getAttribute('data-check');
            var start = performance.now();
            fetch(url, { mode: 'no-cors', signal: AbortSignal.timeout(5000) })
                .then(function() {
                    var elapsed = performance.now() - start;
                    dot.classList.add(elapsed > 3000 ? 'slow' : 'up');
                })
                .catch(function() { dot.classList.add('down'); });
        });
    </script>
</body>
</html>
