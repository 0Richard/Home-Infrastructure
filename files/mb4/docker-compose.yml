# =============================================================================
# MB4 Docker Compose - Local Development Services
# =============================================================================
# Location: ~/docker/docker-compose.yml
#
# Commands:
#   docker compose up -d              Start all services
#   docker compose logs -f            View logs
#   docker compose down               Stop all services
#
# Requires: Colima running (colima start)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL with PostGIS - Local development database
  # Access: localhost:5432
  # Data: ./postgres/data/
  # ---------------------------------------------------------------------------
  postgres:
    container_name: postgres
    image: imresamu/postgis:16-3.4-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-dev}
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # DynamoDB Local - AWS DynamoDB emulator for local development
  # Access: localhost:8000
  # Data: ./dynamodb/data/
  # AWS CLI: aws dynamodb list-tables --endpoint-url http://localhost:8000
  # ---------------------------------------------------------------------------
  dynamodb:
    container_name: dynamodb
    image: amazon/dynamodb-local:latest
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    ports:
      - "8000:8000"
    volumes:
      - ./dynamodb/data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # k6 - Load testing tool
  # Usage: docker compose run --rm k6 run /scripts/test.js
  # Scripts: ./k6/scripts/
  # ---------------------------------------------------------------------------
  k6:
    container_name: k6
    image: grafana/k6:latest
    volumes:
      - ./k6/scripts:/scripts
    profiles:
      - tools

  # ---------------------------------------------------------------------------
  # Nmap - Network scanner for penetration testing
  # Usage: docker compose run --rm nmap -sV 192.168.1.0/24
  # Reports: ./nmap/reports/
  # ---------------------------------------------------------------------------
  nmap:
    container_name: nmap
    image: instrumentisto/nmap:latest
    volumes:
      - ./nmap/reports:/reports
    network_mode: host
    profiles:
      - security

  # ---------------------------------------------------------------------------
  # OpenVAS/Greenbone - Open-source vulnerability scanner
  # Access: https://localhost:9392
  # Default login: admin / admin (change on first login)
  # Data: ./openvas/data/
  # Note: First start takes 10-15 min to sync vulnerability feeds
  # ---------------------------------------------------------------------------
  openvas:
    container_name: openvas
    image: immauss/openvas:latest
    ports:
      - "9392:9392"
    environment:
      - PASSWORD=admin
    volumes:
      - ./openvas/data:/data
    restart: unless-stopped
    profiles:
      - security
